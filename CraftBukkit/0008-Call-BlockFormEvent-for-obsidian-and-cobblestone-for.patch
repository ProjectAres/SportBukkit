From ca3a2bc81f70b1193822ca80d6747201d34ed8b3 Mon Sep 17 00:00:00 2001
From: Steve Anton <anxuiz.nx@gmail.com>
Date: Fri, 5 Oct 2012 12:00:26 -0700
Subject: [PATCH] Call BlockFormEvent for obsidian and cobblestone formation
 due to lava / water interacting.


diff --git a/src/main/java/net/minecraft/server/BlockFluids.java b/src/main/java/net/minecraft/server/BlockFluids.java
index 482f15a..36f8ba6 100644
--- a/src/main/java/net/minecraft/server/BlockFluids.java
+++ b/src/main/java/net/minecraft/server/BlockFluids.java
@@ -210,13 +210,27 @@ public abstract class BlockFluids extends Block {
                 if (flag) {
                     int l = world.getData(i, j, k);
 
+                    // CraftBukkit start
+                    Block formed = null;
                     if (l == 0) {
-                        world.setTypeUpdate(i, j, k, Blocks.OBSIDIAN);
+                        formedId = Blocks.OBSIDIAN;
                     } else if (l <= 4) {
-                        world.setTypeUpdate(i, j, k, Blocks.COBBLESTONE);
+                        formedId = Blocks.COBBLESTONE;
                     }
 
-                    this.fizz(world, i, j, k);
+                    if (formed != null) {
+                        org.bukkit.block.Block block = world.getWorld().getBlockAt(i, j, k);
+                        org.bukkit.block.BlockState newState = block.getState();
+                        newState.setType(org.bukkit.craftbukkit.util.CraftMagicNumbers.getMaterial(formed));
+                        org.bukkit.event.block.BlockFormEvent event = new org.bukkit.event.block.BlockFormEvent(block, newState);
+                        world.getServer().getPluginManager().callEvent(event);
+
+                        if (!event.isCancelled()) {
+                            world.setTypeUpdate(i, j, k, formed);
+                            this.fizz(world, i, j, k);
+                        }
+                    }
+                    // CraftBukkit end
                 }
             }
         }
-- 
1.8.5.1

