From a9d9d5c747ed30248674e31848057e74d4311686 Mon Sep 17 00:00:00 2001
From: mrapple <tony@oc.tc>
Date: Fri, 17 May 2013 20:44:04 -0500
Subject: [PATCH] Add PlayerPickupExperienceEvent


diff --git a/src/main/java/net/minecraft/server/EntityExperienceOrb.java b/src/main/java/net/minecraft/server/EntityExperienceOrb.java
index d79f693..44949d4 100644
--- a/src/main/java/net/minecraft/server/EntityExperienceOrb.java
+++ b/src/main/java/net/minecraft/server/EntityExperienceOrb.java
@@ -147,10 +147,17 @@ public class EntityExperienceOrb extends Entity {
         if (!this.world.isStatic) {
             if (this.c == 0 && entityhuman.bu == 0) {
                 entityhuman.bu = 2;
-                this.world.makeSound(entityhuman, "random.orb", 0.1F, 0.5F * ((this.random.nextFloat() - this.random.nextFloat()) * 0.7F + 1.8F));
-                entityhuman.receive(this, 1);
-                entityhuman.giveExp(CraftEventFactory.callPlayerExpChangeEvent(entityhuman, this.value).getAmount()); // CraftBukkit - this.value to event.getAmount()
-                this.die();
+
+                // CraftBukkit start
+                org.bukkit.event.player.PlayerPickupExperienceEvent event = org.bukkit.craftbukkit.event.CraftEventFactory.callPlayerPickupExperienceEvent((EntityPlayer) entityhuman, this);
+
+                if(!event.isCancelled()) {
+                    // CraftBukkit end
+                    this.world.makeSound(entityhuman, "random.orb", 0.1F, 0.5F * ((this.random.nextFloat() - this.random.nextFloat()) * 0.7F + 1.8F));
+                    entityhuman.receive(this, 1);
+                    entityhuman.giveExp(CraftEventFactory.callPlayerExpChangeEvent(entityhuman, this.value).getAmount()); // CraftBukkit - this.value to event.getAmount()
+                    this.die();
+                }
             }
         }
     }
diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index a91ffb1..3dfd2e8 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -736,6 +736,13 @@ public class CraftEventFactory {
         return event;
     }
 
+    public static PlayerPickupExperienceEvent callPlayerPickupExperienceEvent(EntityPlayer player, net.minecraft.server.EntityExperienceOrb orb) {
+        World world = player.world;
+        PlayerPickupExperienceEvent event = new PlayerPickupExperienceEvent(player.getBukkitEntity(), new org.bukkit.craftbukkit.entity.CraftExperienceOrb(world.getServer(), orb));
+        world.getServer().getPluginManager().callEvent(event);
+        return event;
+    }
+
     public static Cancellable handleStatisticsIncrease(EntityHuman entityHuman, net.minecraft.server.Statistic statistic, int current, int incrementation) {
         Player player = ((EntityPlayer) entityHuman).getBukkitEntity();
         Event event;
-- 
1.8.5.1

